// ==UserScript==
// @name        Tiny Attack Bookmarklet
// @version     1.1.1
// @description Adds information about the units of all players to your Tiny Attack games.
// @author      Fex
// @grant       none
// @homepageURL https://ta-bs.github.io/
// @downloadURL https://ta-bs.github.io/bookmarklet/tabm.user.js
// @updateURL   https://ta-bs.github.io/bookmarklet/tabm.meta.js
// @icon        https://ta-bs.github.io/bookmarklet/icon.png
// @namespace   https://www.tinyattack.com/
// @match       https://www.tinyattack.com/game/view.html?gameId=*
// ==/UserScript==

function doIt(){const t=JSON.parse,e=document,n=e.documentElement.outerHTML,a=t(n.match(/'gameId': (\d+)/)[1]),o=t(n.match(/'cacheId': (-?\d+)/)[1]),i=t(n.match(/'playerId': (\d+)/)[1]),c=t(n.match(/'coinBase': (\d+)/)[1]),s=t(n.match(/'coinTurn': (\d+)/)[1]),r=t(n.match(/'colors': (\[[^\]]+\])/)[1]),d=t(n.match(/, 'tile': (\{[^\}]+\}),/)[1]),l=t(n.match(/, 'unit': (\{[^\}]+\}),/)[1]),h=t(n.match(/game.getMap\(\).addCoordinates\((\{[^\}]+\}\}),/)[1]),m=176===i,u=5===(new Date).getMonth(),p=d.data.filter((t=>t[3])).map((t=>t[0])),g=[],f=[],y=[];h.data.forEach((t=>{const e=t[0]+","+t[1],n=t[2];p.includes(n)&&g.push(e),20===n?f.push(e):7===n&&y.push(e)}));const[b,x,k,I,T,E]=["unitId","skinId","coin","title","type","weight"].map((t=>l.key.indexOf(t))),L=[],w=[];l.data.forEach((t=>{L.push(t[b]),w[t[b]]={cost:t[k],title:t[I],skinId:t[x],typeWeight:t[T]+t[E]}}));const M=["LandLight","LandHeavy","AirLight","AirHeavy","WaterLight","WaterHeavy","WaterStealth"];function O(t,e){t.appendChild(e)}function S(t){return e.createElement(t)}function v(t,n,a){const o=S("td");o.title=n??t,O(o,e.createTextNode("number"==typeof t?t.toLocaleString():t));const i=o.style;return i.color=a??"#fff",i.fontSize="14px",i.fontWeight="bolder",i.textAlign="center",i.padding="4px 8px",o}L.sort(((t,e)=>{const n=M.indexOf(w[t].typeWeight),a=M.indexOf(w[e].typeWeight);return n===a?w[t].cost-w[e].cost:n-a})),fetch("https://cdn.tinyattack.com/game/"+a+"/public.json").then((t=>t.json())).then((t=>{const n=t.player.data,a=t.player.key.indexOf("coin"),i=n.length,d=[];for(let t=0;t<i;t++)d[t+1]={coin:n[t][a],income:s,strength:0,potential:0,units:[]},L.forEach((e=>d[t+1].units[e]={count:0,health:0}));const[l,h,p,b,x,k]=["x","y","unitId","unitHealth","unitPlayer","tilePlayer"].map((e=>t.coordinate.key.indexOf(e)));t.coordinate.data.forEach((t=>{const e=t[p],n=t[b],a=t[x],o=t[k],i=t[l]+","+t[h];o&&g.includes(i)&&(d[o].income+=c),e&&n&&a&&(d[a].strength+=w[e].cost*n/10,d[a].potential+=w[e].cost,d[a].units[e].count+=1,d[a].units[e].health+=n,40===e&&(f.includes(i)?d[a].income+=Math.floor(75*n/10):y.includes(i)&&(d[a].income+=Math.floor(25*n/10))))}));const I=L.filter((t=>d.some((e=>e.units[t].count>0)))),T=S("table");T.style.marginTop="4px",T.style.marginBottom="8px";const E=S("tr");m&&O(E,v("$","$","#000")),I.forEach((t=>{const e=S("td"),n=S("img");n.alt=n.title=w[t].title,n.width="48",n.height="51";const a=u?Math.floor(12*Math.random()+1):0;n.src="https://cdn.tinyattack.com/img/skin/"+w[t].skinId+"/"+a+".png?t=0",O(e,n),O(E,e)})),O(E,v("INC","Income","#000")),O(E,v("STR","Current Army Strength","#000")),O(E,v("POT","Army Potential","#000"));const M=v("STR","STR/POT","#000");M.innerHTML="<sup>STR</sup>&frasl;<sub>POT</sub>",O(E,M),O(T,E),d.forEach(((t,e)=>{const n=S("tr");m&&O(n,v(t.coin)),n.style.backgroundColor=r[e].hex.darker,n.style.border="1px solid black",I.forEach((e=>{O(n,v(t.units[e].count))})),O(n,v(t.income)),O(n,v(Math.round(t.strength))),O(n,v(t.potential)),O(n,v(0===t.potential?"-":Math.round(100*t.strength/t.potential)+"%")),O(T,n)}));const W=S("a");W.href="https://ta-bs.github.io/?cache="+o,W.target="_blank",W.classList.add("btn","btn-primary","w-lg-auto");const B=S("span");B.classList.add("fa","fa-external-link-alt"),O(W,B),O(W,e.createTextNode(" Open Battle Simulator"));const C=S("button");C.classList.add("btn","btn-primary","w-lg-auto"),C.addEventListener("click",(()=>{C.disabled=!0,doIt()}));const H=S("span");H.classList.add("fa","fa-redo"),O(C,H),O(C,e.createTextNode(" Refresh"));const N=S("div");O(N,W),O(N,e.createTextNode(" ")),O(N,C);const P=S("div");P.id="tabsbm",P.style.marginBottom="12px",O(P,T),O(P,N);const A=e.getElementById("tabsbm"),R=e.getElementById("game"),j=R.parentElement;A&&j.removeChild(A),j.insertBefore(P,R)}))}window.location.href.startsWith("https://www.tinyattack.com/game/view.html?gameId=")&&doIt();
