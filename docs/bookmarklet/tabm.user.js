// ==UserScript==
// @name        Tiny Attack Bookmarklet
// @version     1.0.5
// @description Adds information about the units of all players to your Tiny Attack games.
// @author      Fex
// @grant       none
// @homepageURL https://ta-bs.github.io/
// @downloadURL https://ta-bs.github.io/bookmarklet/tabm.user.js
// @updateURL   https://ta-bs.github.io/bookmarklet/tabm.meta.js
// @icon        https://ta-bs.github.io/bookmarklet/icon.png
// @namespace   https://www.tinyattack.com/
// @match       https://www.tinyattack.com/game/view.html?gameId=*
// ==/UserScript==

function doIt(){const t=JSON.parse,e=document,n=e.documentElement.outerHTML,a=t(n.match(/'gameId': (\d+)/)[1]),o=t(n.match(/'playerId': (\d+)/)[1]),i=t(n.match(/'coinBase': (\d+)/)[1]),c=t(n.match(/'coinTurn': (\d+)/)[1]),s=t(n.match(/'colors': (\[[^\]]+\])/)[1]),r=t(n.match(/, 'tile': (\{[^\}]+\}),/)[1]),d=t(n.match(/, 'unit': (\{[^\}]+\}),/)[1]),l=t(n.match(/game.getMap\(\).addCoordinates\((\{[^\}]+\}\}),/)[1]),h=176===o,m=5===(new Date).getMonth(),p=r.data.filter((t=>t[3])).map((t=>t[0])),u=[],g=[],f=[];l.data.forEach((t=>{const e=t[0]+","+t[1],n=t[2];p.includes(n)&&u.push(e),20===n?g.push(e):7===n&&f.push(e)}));const[y,b,x,k,T,I]=["unitId","skinId","coin","title","type","weight"].map((t=>d.key.indexOf(t))),E=[],L=[];d.data.forEach((t=>{E.push(t[y]),L[t[y]]={cost:t[x],title:t[k],skinId:t[b],typeWeight:t[T]+t[I]}}));const w=["LandLight","LandHeavy","AirLight","AirHeavy","WaterLight","WaterHeavy","WaterStealth"];function O(t,e){t.appendChild(e)}function S(t){return e.createElement(t)}function M(t,n,a){const o=S("td");o.title=n??t,O(o,e.createTextNode("number"==typeof t?t.toLocaleString():t));const i=o.style;return i.color=a??"#fff",i.fontSize="14px",i.fontWeight="bolder",i.textAlign="center",i.padding="4px 8px",o}E.sort(((t,e)=>{const n=w.indexOf(L[t].typeWeight),a=w.indexOf(L[e].typeWeight);return n===a?L[t].cost-L[e].cost:n-a})),fetch("https://cdn.tinyattack.com/game/"+a+"/public.json").then((t=>t.json())).then((t=>{const n=t.player.data,a=t.player.key.indexOf("coin"),o=n.length,r=[];for(let t=0;t<o;t++)r[t+1]={coin:n[t][a],income:c,strength:0,potential:0,units:[]},E.forEach((e=>r[t+1].units[e]={count:0,health:0}));const[d,l,p,y,b,x]=["x","y","unitId","unitHealth","unitPlayer","tilePlayer"].map((e=>t.coordinate.key.indexOf(e)));t.coordinate.data.forEach((t=>{const e=t[d],n=t[l],a=t[p],o=t[y],c=t[b],s=t[x],h=e+","+n;s&&u.includes(h)&&(r[s].income+=i),a&&o&&c&&(r[c].strength+=L[a].cost*o/10,r[c].potential+=L[a].cost,r[c].units[a].count+=1,r[c].units[a].health+=o,40===a&&(g.includes(h)?r[c].income+=75*o/10:f.includes(h)&&(r[c].income+=25*o/10)))}));const k=E.filter((t=>r.some((e=>e.units[t].count>0)))),T=S("table");T.style.marginTop="4px",T.style.marginBottom="8px";const I=S("tr");h&&O(I,M("$","$","#000")),k.forEach((t=>{const e=S("td"),n=S("img");n.alt=n.title=L[t].title,n.width="48",n.height="51";const a=m?Math.floor(12*Math.random()+1):0;n.src="https://cdn.tinyattack.com/img/skin/"+L[t].skinId+"/"+a+".png?t=0",O(e,n),O(I,e)})),O(I,M("INC","Income","#000")),O(I,M("STR","Current Army Strength","#000")),O(I,M("POT","Army Potential","#000"));const w=M("STR","STR/POT","#000");w.innerHTML="<sup>STR</sup>&frasl;<sub>POT</sub>",O(I,w),O(T,I),r.forEach(((t,e)=>{const n=S("tr");h&&O(n,M(t.coin)),n.style.backgroundColor=s[e].hex.darker,n.style.border="1px solid black",k.forEach((e=>{O(n,M(t.units[e].count))})),O(n,M(Math.floor(t.income))),O(n,M(Math.round(t.strength))),O(n,M(t.potential)),O(n,M(0===t.potential?"-":Math.round(100*t.strength/t.potential)+"%")),O(T,n)}));const v=S("a");v.href="https://ta-bs.github.io/",v.target="_blank",v.classList.add("btn","btn-primary","w-lg-auto");const W=S("span");W.classList.add("fa","fa-external-link-alt"),O(v,W),O(v,e.createTextNode(" Open Battle Simulator"));const B=S("button");B.classList.add("btn","btn-primary","w-lg-auto"),B.addEventListener("click",(()=>{B.disabled=!0,doIt()}));const C=S("span");C.classList.add("fa","fa-redo"),O(B,C),O(B,e.createTextNode(" Refresh"));const H=S("div");O(H,v),O(H,e.createTextNode(" ")),O(H,B);const N=S("div");N.id="tabsbm",N.style.marginTop="4px",N.style.marginBottom="8px",O(N,T),O(N,H);const P=e.getElementById("tabsbm"),A=e.getElementById("game"),R=A.parentElement;P&&R.removeChild(P),R.insertBefore(N,A)}))}window.location.href.startsWith("https://www.tinyattack.com/game/view.html?gameId=")&&doIt();
