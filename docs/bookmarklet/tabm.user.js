// ==UserScript==
// @name        Tiny Attack Bookmarklet
// @version     1.0.4
// @description Adds information about the units of all players to your Tiny Attack games.
// @author      Fex
// @grant       none
// @homepageURL https://ta-bs.github.io/
// @downloadURL https://ta-bs.github.io/bookmarklet/tabm.user.js
// @updateURL   https://ta-bs.github.io/bookmarklet/tabm.meta.js
// @icon        https://ta-bs.github.io/bookmarklet/icon.png
// @namespace   https://www.tinyattack.com/
// @match       https://www.tinyattack.com/game/view.html?gameId=*
// ==/UserScript==


function doIt(){const t=JSON.parse,e=document,n=e.documentElement.outerHTML,a=t(n.match(/'gameId': (\d+)/)[1]),o=t(n.match(/'playerId': (\d+)/)[1]),r=t(n.match(/'colors': (\[[^\]]+\])/)[1]),s=t(n.match(/, 'unit': ([^']+),/)[1]),c=176===o,i=5===(new Date).getMonth(),[d,l,h,m,p,u]=["unitId","skinId","coin","title","type","weight"].map((t=>s.key.indexOf(t))),f=[],g=[];s.data.forEach((t=>{f.push(t[d]),g[t[d]]={c:t[h],t:t[m],s:t[l],tw:t[p]+t[u]}}));const y=["LandLight","LandHeavy","AirLight","AirHeavy","WaterLight","WaterHeavy","WaterStealth"];function b(t,e){t.appendChild(e)}function x(t){return e.createElement(t)}function T(t,n,a){const o=x("td");o.title=n??t,b(o,e.createTextNode("number"==typeof t?t.toLocaleString():t));const r=o.style;return r.color=a??"#fff",r.fontSize="14px",r.fontWeight="bolder",r.textAlign="center",r.padding="5px",o}f.sort(((t,e)=>{const n=y.indexOf(g[t].tw),a=y.indexOf(g[e].tw);return n===a?g[t].c-g[e].c:n-a})),fetch("https://cdn.tinyattack.com/game/"+a+"/public.json").then((t=>t.json())).then((t=>{const n=t.player.data,a=n.length,o=[];for(let t=0;t<a;t++)o[t+1]={c:n[t][12],s:0,p:0,u:[]},f.forEach((e=>o[t+1].u[e]={n:0,h:0}));t.coordinate.data.forEach((t=>{const e=t[2],n=t[5],a=t[3];e&&n&&a&&(o[a].s+=g[e].c*n/10,o[a].p+=g[e].c,o[a].u[e].n+=1,o[a].u[e].h+=n)}));const s=f.filter((t=>o.some((e=>e.u[t].n>0)))),d=x("table");d.style.marginTop="4px",d.style.marginBottom="8px";const l=x("tr");c&&b(l,T("$","$","#000")),s.forEach((t=>{const e=x("td"),n=x("img");n.alt=n.title=g[t].t;const a=i?Math.floor(12*Math.random()+1):0;n.src="https://cdn.tinyattack.com/img/skin/"+g[t].s+"/"+a+".png?t=0",b(e,n),b(l,e)})),b(l,T("STR","Current Army Strength","#000")),b(l,T("POT","Army Potential","#000"));const h=T("STR","STR/POT","#000");h.innerHTML="<sup>STR</sup>&frasl;<sub>POT</sub>",b(l,h),b(d,l),o.forEach(((t,e)=>{const n=x("tr");c&&b(n,T(t.c)),n.style.backgroundColor=r[e].hex.darker,n.style.border="1px solid black",s.forEach((e=>{b(n,T(t.u[e].n))})),b(n,T(Math.round(t.s))),b(n,T(t.p)),b(n,T(0===t.p?"-":Math.round(100*t.s/t.p)+"%")),b(d,n)}));const m=x("a");m.href="https://ta-bs.github.io/",m.target="_blank",m.classList.add("btn","btn-primary","w-lg-auto");const p=x("span");p.classList.add("fa","fa-external-link-alt"),b(m,p),b(m,e.createTextNode(" Open Battle Simulator"));const u=x("button");u.classList.add("btn","btn-primary","w-lg-auto"),u.addEventListener("click",(()=>{u.disabled=!0,doIt()}));const y=x("span");y.classList.add("fa","fa-redo"),b(u,y),b(u,e.createTextNode(" Refresh"));const w=x("div");b(w,m),b(w,e.createTextNode(" ")),b(w,u);const L=x("div");L.id="tabsbm",L.style.marginTop="4px",L.style.marginBottom="8px",b(L,d),b(L,w);const k=e.getElementById("tabsbm"),E=e.getElementById("game"),I=E.parentElement;k&&I.removeChild(k),I.insertBefore(L,E)}))}window.location.href.startsWith("https://www.tinyattack.com/game/view.html?gameId=")&&doIt();
