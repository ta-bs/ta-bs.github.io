// ==UserScript==
// @name        Tiny Attack Bookmarklet
// @version     1.2.0
// @description Adds information about the units of all players to your Tiny Attack games.
// @author      Fex
// @grant       none
// @homepageURL https://ta-bs.github.io/
// @downloadURL https://ta-bs.github.io/bookmarklet/tabm.user.js
// @updateURL   https://ta-bs.github.io/bookmarklet/tabm.meta.js
// @icon        https://ta-bs.github.io/bookmarklet/icon.png
// @namespace   https://www.tinyattack.com/
// @match       https://www.tinyattack.com/game/view.html?gameId=*
// ==/UserScript==

(()=>{"use strict";const t=document,i=t.createElement.bind(t),e=t.createTextNode.bind(t),s=(t,i)=>t.appendChild(i);class n{t;i;h;o;constructor(t,i,e,s){this.t=t,this.i=i,this.h=e,this.o=s}u(){const t=i("div");return s(t,this.l()),s(t,this.m()),t}l(){const t=i("table");return t.style.marginTop="4px",t.style.marginBottom="8px",s(t,this.I()),this.t.p().forEach((i=>s(t,this._(i)))),t}I(){const t="#000",e=i("tr");this.h&&s(e,this.T("$","Coins",t)),this.t.k().forEach((t=>{const n=i("td"),r=i("img");r.alt=r.title=this.t.v(t),r.width=48,r.height=51,r.src=this.i.O(this.t.P(t)),s(n,r),s(e,n)})),s(e,this.T("INC","Income",t)),s(e,this.T("STR","Army Strength",t)),s(e,this.T("POT","Army Potential",t));const n=this.T("STR/POT","STR/POT",t);return n.innerHTML="<sup>STR</sup>&frasl;<sub>POT</sub>",s(e,n),e}_(t){const e=i("tr");e.style.backgroundColor=this.t.B(t),e.style.border="1px solid black",this.h&&s(e,this.T(this.t.M(t))),this.t.k().forEach((i=>s(e,this.T(this.t.R(t,i)))));const n=this.t.S(t),r=this.t.C(t),h=this.t.W(t);return s(e,this.T(n)),s(e,this.T(Math.round(r))),s(e,this.T(h)),s(e,this.T(0===h?"-":Math.round(100*r/h)+"%")),e}T(t,n,r="#fff"){const h=i("td");n&&(h.title=n),s(h,e("number"==typeof t?t.toLocaleString():t));const o=h.style;return o.color=r,o.fontSize="14px",o.fontWeight="bolder",o.textAlign="center",o.padding="4px 8px",h}m(){const t=i("div");return s(t,this.L()),s(t,e(" ")),s(t,this.N()),t}L(){const t=i("a");t.href="https://ta-bs.github.io/?cache="+this.t.A(),t.target="_blank",t.classList.add("btn","btn-primary","w-lg-auto");const n=i("span");return n.classList.add("fa","fa-external-link-alt"),s(t,n),s(t,e(" Open Battle Simulator")),t}N(){const t=i("button");t.classList.add("btn","btn-primary","w-lg-auto"),t.addEventListener("click",(()=>{t.disabled=!0,this.o()}));const n=i("span");return n.classList.add("fa","fa-redo"),s(t,n),s(t,e(" Refresh")),t}}const r=(t,i)=>"https://cdn.tinyattack.com/img/skin/"+t+"/"+i+".png?t=0";class h{O(t){return r(t,0)}}class o{O(t){const i=Math.floor(12*Math.random()+1);return r(t,i)}}class a{D;H;constructor(t,i){this.D=t,this.H=i}U(){return this.D.U}A(){return this.D.A}J(){return this.D.J}p(){return this.H.p()}B(t){return this.D.B(t)}M(t){return this.H.j(t)}S(t){let i=this.D.$;return i+=this.H.q(t)*this.D.F,this.H.G(t).forEach((t=>{this.D.K(t.x,t.y)?i+=Math.floor(25*t.V/10):this.D.X(t.x,t.y)&&(i+=Math.floor(75*t.V/10))})),i}C(t){return this.H.units(t).map((t=>{const i=this.D.unitType(t.Y);return i?i.Z*t.V/10:0})).reduce(((t,i)=>t+i),0)}W(t){return this.H.units(t).map((t=>this.D.unitType(t.Y)?.Z??0)).reduce(((t,i)=>t+i),0)}R(t,i){return this.H.R(t,i)}k(){const t=["LandLight","LandHeavy","AirLight","AirHeavy","WaterLight","WaterHeavy","WaterStealth"];return this.D.tt().sort(((i,e)=>{const s=t.indexOf(i.it),n=t.indexOf(e.it);return s===n?i.Z-e.Z:s-n})).map((t=>t.Y)).filter((t=>this.H.R(void 0,t)>0))}v(t){return this.D.unitType(t)?.title??""}P(t){return this.D.unitType(t)?.et??0}}class c{st;constructor(t){this.st=t}nt(){const t=this.st.game.key.indexOf("round");return this.st.game.data[0][t]}rt(){const t=this.st.player.key.indexOf("active");return this.st.player.data.findIndex((i=>!0===i[t]))}p(){const t=this.st.player.data.length;return[1,2,3,4,5,6,7,8,9,10,11,12].slice(0,t)}j(t){const i=this.st.player.key.indexOf("coin");return this.st.player.data[t-1][i]}q(t){const i=this.st.coordinate.key.indexOf("tilePlayer");return this.st.coordinate.data.map((t=>t[i])).filter((i=>i===t)).length}R(t,i){const e=this.st.coordinate.key.indexOf("unitId"),s=this.st.coordinate.key.indexOf("unitPlayer");return this.st.coordinate.data.filter((i=>void 0===t||i[s]===t)).filter((t=>t[e]===i)).length}units(t){const[i,e,s,n,r]=["x","y","unitId","unitHealth","unitPlayer"].map((t=>this.st.coordinate.key.indexOf(t)));return this.st.coordinate.data.filter((i=>void 0===t||i[r]===t)).map((t=>({Y:t[s],ht:t[r],x:t[i],y:t[e],V:t[n]})))}G(t){return this.units(t).filter((t=>40===t.Y))}}class u{ot;ct;ut;lt;dt;It;gt;yt;ft;constructor(t){const i=(i,e)=>{const s=t.match(i);if(null===s)throw Error("problem parsing html for "+e);return JSON.parse(s[1])};this.ot=i(/gameId: (\d+),/,"gameId"),this.ct=i(/cacheId: (-?\d+),/,"cacheId"),this.ut=i(/playerId: (\d+),/,"playerId"),this.lt=i(/coinTurn: (\d+),/,"coinTurn"),this.dt=i(/coinBase: (\d+),/,"coinBase"),this.It=i(/tile: (\{[^}]+\}),/,"tile"),this.gt=i(/data: (\{[^}]+\}),/,"coordinates"),this.yt=i(/unit: (\{[^}]+\}),/,"unit"),this.ft=i(/colors: (\[[^\]]+\])/,"colors")}get U(){return this.ot}get A(){return this.ct}get J(){return this.ut}get $(){return this.lt}get F(){return this.dt}tt(){const[t,i,e,s,n,r]=["unitId","skinId","coin","title","type","weight"].map((t=>this.yt.key.indexOf(t)));return this.yt.data.map((h=>({Y:h[t],title:h[s],Z:h[e],et:h[i],it:h[n]+h[r]})))}unitType(t){const[i,e,s,n,r,h]=["unitId","skinId","coin","title","type","weight"].map((t=>this.yt.key.indexOf(t))),o=this.yt.data.find((e=>e[i]===t));if(o)return{Y:o[i],title:o[n],Z:o[s],et:o[e],it:o[r]+o[h]}}B(t){return this.ft[t].hex.darker}K(t,i){return 7===this.bt(t,i)}X(t,i){return 20===this.bt(t,i)}bt(t,i){const e=this.gt.key.indexOf("x"),s=this.gt.key.indexOf("y"),n=this.gt.key.indexOf("tileId"),r=this.gt.data.find((n=>n[e]===t&&n[s]===i));return r?r[n]:void 0}}class l{ot;ct;ut;lt;dt;It;gt;yt;ft;constructor(t){const i=(i,e)=>{const s=t.match(i);if(null===s)throw Error("problem parsing html for "+e);return JSON.parse(s[1])};this.ot=i(/'gameId': (\d+)/,"gameId"),this.ct=i(/'cacheId': (-?\d+)/,"cacheId"),this.ut=i(/'playerId': (\d+)/,"playerId"),this.lt=i(/'coinTurn': (\d+)/,"coinTurn"),this.dt=i(/'coinBase': (\d+)/,"coinBase"),this.It=i(/, 'tile': (\{[^}]+\}),/,"tile"),this.gt=i(/game.getMap\(\).addCoordinates\((\{[^}]+\}\}?),/,"coordinates"),this.yt=i(/, 'unit': (\{[^}]+\}),/,"unit"),this.ft=i(/'colors': (\[[^\]]+\])/,"colors")}get U(){return this.ot}get A(){return this.ct}get J(){return this.ut}get $(){return this.lt}get F(){return this.dt}tt(){const[t,i,e,s,n,r]=["unitId","skinId","coin","title","type","weight"].map((t=>this.yt.key.indexOf(t)));return this.yt.data.map((h=>({Y:h[t],title:h[s],Z:h[e],et:h[i],it:h[n]+h[r]})))}unitType(t){const[i,e,s,n,r,h]=["unitId","skinId","coin","title","type","weight"].map((t=>this.yt.key.indexOf(t))),o=this.yt.data.find((e=>e[i]===t));if(o)return{Y:o[i],title:o[n],Z:o[s],et:o[e],it:o[r]+o[h]}}B(t){return this.ft[t].hex.darker}K(t,i){return 7===this.bt(t,i)}X(t,i){return 20===this.bt(t,i)}bt(t,i){const e=this.gt.key.indexOf("x"),s=this.gt.key.indexOf("y"),n=this.gt.key.indexOf("tileId"),r=this.gt.data.find((n=>n[e]===t&&n[s]===i));return r?r[n]:void 0}}function d(t){const i=document,e="tabsbm",s=t(i.documentElement.outerHTML);(async t=>(await fetch("https://cdn.tinyattack.com/game/"+t+"/public.json")).json())(s.U).then((r=>{const u=new c(r),l=new a(s,u),m=5===(new Date).getMonth()?new o:new h,I=new n(l,m,176===l.J(),(()=>d(t))).u();I.id=e,I.style.marginBottom="12px",I.style.zIndex="2";const p=i.getElementById(e),g=i.getElementById("game"),y=g?.parentElement;g&&y?(p&&y.removeChild(p),y.insertBefore(I,g)):console.warn("html borked")}))}if(window.location.href.startsWith("https://www.tinyattack.com/game/view.html?gameId="))console.log("tabsbm using normal interface"),d((t=>new l(t)));else if(window.location.href.startsWith("https://www.tinyattack.com/game/test.html?gameId=")){console.log("tabsbm using experimental interface");const t=document;t.getElementById("game").style.position="relative",t.getElementById("game-map").classList.remove("bottom-0"),t.getElementById("game-panel").classList.remove("h-100");const i=t.getElementById("game-hud").firstElementChild;i.classList.remove("h-100"),i.style.height="100vh",d((t=>new u(t)))}})();
